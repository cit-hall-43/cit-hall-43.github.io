<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è±¬ç± è‰ç’°å¢ƒç›£æ¸¬ç³»çµ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .dashboard { max-width: 1400px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .header p { font-size: 1.2em; opacity: 0.9; }
        .controls { display: flex; justify-content: center; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; }
        .control-group { background: rgba(255, 255, 255, 0.9); padding: 15px; border-radius: 10px; }
        .control-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #2c3e50; }
        .control-group input, .control-group button { padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
        .control-group button { background: #3498db; color: white; border: none; cursor: pointer; transition: background 0.3s; }
        .control-group button:hover { background: #2980b9; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: rgba(255, 255, 255, 0.95); border-radius: 15px; padding: 25px; text-align: center; box-shadow: 0 8px 32px rgba(0,0,0,0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); transition: transform 0.3s ease; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-value { font-size: 2.5em; font-weight: bold; color: #2c3e50; margin-bottom: 10px; }
        .stat-label { font-size: 1.1em; color: #7f8c8d; font-weight: 500; }
        .stat-unit { font-size: 0.8em; color: #95a5a6; }
        .charts-grid { display: grid; grid-template-columns: 1fr; gap: 30px; }
        .chart-container { background: rgba(255, 255, 255, 0.95); border-radius: 15px; padding: 25px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
        .chart-title { font-size: 1.5em; color: #2c3e50; margin-bottom: 20px; text-align: center; font-weight: 600; }
        .chart-wrapper { position: relative; height: 400px; margin-bottom: 20px; }
        .dual-chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .radar-wrapper { height: 350px; }
        @media (max-width: 768px) { .dual-chart-grid { grid-template-columns: 1fr; } .stats-grid { grid-template-columns: repeat(2, 1fr); } .header h1 { font-size: 2em; } .controls { flex-direction: column; align-items: center; } }
        .temp { color: #e74c3c; } .humidity { color: #3498db; } .soil { color: #27ae60; } .light { color: #f39c12; }
        .status { margin: 10px 0; padding: 10px; border-radius: 5px; text-align: center; font-weight: bold; }
        .status.loading { background: rgba(52, 152, 219, 0.2); color: #2980b9; }
        .status.success { background: rgba(39, 174, 96, 0.2); color: #27ae60; }
        .status.error { background: rgba(231, 76, 60, 0.2); color: #e74c3c; }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>ğŸª´ è±¬ç± è‰ç’°å¢ƒç›£æ¸¬ç³»çµ±</h1>
            <p>æ”¯æ´CSVæª”æ¡ˆä¸Šå‚³æˆ–JSON APIè³‡æ–™ä¾†æº</p>
        </div>

        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="controls">
            <div class="control-group">
                <label for="fileInput">ä¸Šå‚³CSVæª”æ¡ˆï¼š</label>
                <input type="file" id="fileInput" accept=".csv">
            </div>
            <div class="control-group">
                <label for="jsonUrl">JSON APIç¶²å€ï¼š</label>
                <input type="url" id="jsonUrl" value="https://script.google.com/macros/s/AKfycbxTFL5RSzL5XVQ5feMgDR8jn04wYm849f9E9EZo17tKmqSbP-s3yYF4kF2-CYT1Fg5Wpg/exec" style="width: 300px;">
                <button onclick="loadFromJson()">è¼‰å…¥JSONè³‡æ–™</button>
            </div>
            <div class="control-group">
                <button onclick="downloadJsonTemplate()">ä¸‹è¼‰JSONç¯„æœ¬</button>
                <button onclick="startAutoRefresh()">è‡ªå‹•æ›´æ–° (30ç§’)</button>
                <button onclick="stopAutoRefresh()">åœæ­¢è‡ªå‹•æ›´æ–°</button>
            </div>
        </div>

        <!-- ç‹€æ…‹é¡¯ç¤º -->
        <div id="status" class="status" style="display: none;"></div>
        
        <!-- å³æ™‚æ•¸æ“š -->
        <div class="stats-grid">
            <div class="stat-card"><div class="stat-value temp" id="current-temp">--</div><div class="stat-label">ç›®å‰æº«åº¦ <span class="stat-unit">Â°C</span></div></div>
            <div class="stat-card"><div class="stat-value humidity" id="current-humidity">--</div><div class="stat-label">ç’°å¢ƒæ¿•åº¦ <span class="stat-unit">%</span></div></div>
            <div class="stat-card"><div class="stat-value soil" id="current-soil">--</div><div class="stat-label">åœŸå£¤æ¿•åº¦ <span class="stat-unit">%</span></div></div>
            <div class="stat-card"><div class="stat-value light" id="current-light">--</div><div class="stat-label">å…‰ç…§å¼·åº¦ <span class="stat-unit">lux</span></div></div>
        </div>
        
        <!-- åœ–è¡¨ -->
        <div class="charts-grid">
            <div class="chart-container"><div class="chart-title">ğŸ“Š ç’°å¢ƒåƒæ•¸æ™‚é–“è¶¨å‹¢åœ–</div><div class="chart-wrapper"><canvas id="timeSeriesChart"></canvas></div></div>
            <div class="chart-container"><div class="chart-title">ğŸŒ¡ï¸ æº«æ¿•åº¦è®ŠåŒ– vs å…‰ç…§å¼·åº¦</div><div class="chart-wrapper"><canvas id="dualAxisChart"></canvas></div></div>
            <div class="dual-chart-grid">
                <div class="chart-container"><div class="chart-title">ğŸ¯ ç•¶å‰ç’°å¢ƒç‹€æ…‹é›·é”åœ–</div><div class="radar-wrapper"><canvas id="radarChart"></canvas></div></div>
                <div class="chart-container"><div class="chart-title">ğŸ“ˆ 24å°æ™‚å¹³å‡å€¼æ¯”è¼ƒ</div><div class="radar-wrapper"><canvas id="barChart"></canvas></div></div>
            </div>
        </div>
    </div>

    <script>
        let autoRefreshInterval = null;
        let existingCharts = {};

        // æ¨è–¦çš„JSONæ ¼å¼ç¯„ä¾‹
        const sampleJsonData = {
            "metadata": {
                "station_name": "è±¬ç± è‰æº«å®¤Aå€",
                "last_updated": "2025-08-15T08:41:29Z",
                "total_records": 34,
                "data_source": "IoTæ„Ÿæ¸¬å™¨ç¶²è·¯"
            },
            "readings": [
                {
                    "timestamp": "2025-08-13T23:40:01Z",
                    "temperature": 26.7,
                    "humidity": 69.6,
                    "soil_moisture": 58,
                    "light_intensity": 0,
                    "sensor_id": "20",
                    "location": "192.168.1.26"
                },
                {
                    "timestamp": "2025-08-14T00:40:14Z",
                    "temperature": 27.7,
                    "humidity": 67.6,
                    "soil_moisture": 60,
                    "light_intensity": 0,
                    "sensor_id": "20",
                    "location": "192.168.1.26"
                },
                {
                    "timestamp": "2025-08-14T06:40:17Z",
                    "temperature": 26.2,
                    "humidity": 66.5,
                    "soil_moisture": 58,
                    "light_intensity": 914,
                    "sensor_id": "20",
                    "location": "192.168.1.26"
                },
                {
                    "timestamp": "2025-08-14T12:40:33Z",
                    "temperature": 32.0,
                    "humidity": 60.6,
                    "soil_moisture": 59,
                    "light_intensity": 3845,
                    "sensor_id": "20",
                    "location": "192.168.1.26"
                },
                {
                    "timestamp": "2025-08-14T18:40:53Z",
                    "temperature": 28.4,
                    "humidity": 66.1,
                    "soil_moisture": 54,
                    "light_intensity": 4,
                    "sensor_id": "20",
                    "location": "192.168.1.26"
                },
                {
                    "timestamp": "2025-08-15T08:41:29Z",
                    "temperature": 29.2,
                    "humidity": 76.2,
                    "soil_moisture": 55,
                    "light_intensity": 65536,
                    "sensor_id": "20",
                    "location": "192.168.1.26"
                }
            ]
        };

        // CSVæ–‡ä»¶ä¸Šå‚³è™•ç†
        document.getElementById('fileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;

            showStatus('æ­£åœ¨è®€å–CSVæª”æ¡ˆ...', 'loading');
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvText = e.target.result;
                    const data = parseCSV(csvText);
                    createCharts(data);
                    showStatus(`æˆåŠŸè¼‰å…¥ ${data.length} ç­†CSVè³‡æ–™`, 'success');
                } catch (error) {
                    showStatus(`CSVè®€å–éŒ¯èª¤: ${error.message}`, 'error');
                }
            };
            reader.readAsText(file, 'UTF-8');
        });

        // å¾JSON URLè¼‰å…¥è³‡æ–™
        async function loadFromJson() {
            const url = document.getElementById('jsonUrl').value.trim();
            if (!url) {
                showStatus('è«‹è¼¸å…¥æœ‰æ•ˆçš„JSON APIç¶²å€', 'error');
                return;
            }

            showStatus('æ­£åœ¨å¾APIè¼‰å…¥è³‡æ–™...', 'loading');
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const jsonData = await response.json();
                const data = parseJSON(jsonData);
                createCharts(data);
                showStatus(`æˆåŠŸè¼‰å…¥ ${data.length} ç­†JSONè³‡æ–™`, 'success');
            } catch (error) {
                showStatus(`JSONè¼‰å…¥éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        // è¼‰å…¥ç¯„ä¾‹è³‡æ–™
        function loadSampleData() {
            showStatus('è¼‰å…¥ç¯„ä¾‹è³‡æ–™ä¸­...', 'loading');
            try {
                const data = parseJSON(sampleJsonData);
                createCharts(data);
                showStatus(`è¼‰å…¥ ${data.length} ç­†ç¯„ä¾‹è³‡æ–™`, 'success');
            } catch (error) {
                showStatus(`ç¯„ä¾‹è³‡æ–™è¼‰å…¥éŒ¯èª¤: ${error.message}`, 'error');
            }
        }

        // ä¸‹è¼‰JSONç¯„æœ¬
        function downloadJsonTemplate() {
            const template = {
                "metadata": {
                    "station_name": "è±¬ç± è‰æº«å®¤Aå€",
                    "last_updated": new Date().toISOString(),
                    "total_records": 6,
                    "data_source": "IoTæ„Ÿæ¸¬å™¨ç¶²è·¯",
                    "description": "é€™æ˜¯JSONæ ¼å¼ç¯„æœ¬ï¼Œè«‹æŒ‰ç…§æ­¤çµæ§‹æä¾›æ‚¨çš„æ„Ÿæ¸¬å™¨è³‡æ–™"
                },
                "readings": [
                    {
                        "timestamp": "2025-08-13T23:40:01Z",
                        "temperature": 26.7,
                        "humidity": 69.6,
                        "soil_moisture": 58,
                        "light_intensity": 0,
                        "sensor_id": "20",
                        "location": "192.168.1.26"
                    },
                    {
                        "timestamp": "2025-08-14T06:40:17Z",
                        "temperature": 26.2,
                        "humidity": 66.5,
                        "soil_moisture": 58,
                        "light_intensity": 914,
                        "sensor_id": "20",
                        "location": "192.168.1.26"
                    },
                    {
                        "timestamp": "2025-08-14T12:40:33Z",
                        "temperature": 32.0,
                        "humidity": 60.6,
                        "soil_moisture": 59,
                        "light_intensity": 3845,
                        "sensor_id": "20",
                        "location": "192.168.1.26"
                    },
                    {
                        "timestamp": "2025-08-14T18:40:53Z",
                        "temperature": 28.4,
                        "humidity": 66.1,
                        "soil_moisture": 54,
                        "light_intensity": 4,
                        "sensor_id": "20",
                        "location": "192.168.1.26"
                    },
                    {
                        "timestamp": "2025-08-15T06:41:23Z",
                        "temperature": 27.6,
                        "humidity": 69.7,
                        "soil_moisture": 54,
                        "light_intensity": 845,
                        "sensor_id": "20",
                        "location": "192.168.1.26"
                    },
                    {
                        "timestamp": "2025-08-15T08:41:29Z",
                        "temperature": 29.2,
                        "humidity": 76.2,
                        "soil_moisture": 55,
                        "light_intensity": 65536,
                        "sensor_id": "20",
                        "location": "192.168.1.26"
                    }
                ]
            };

            const jsonString = JSON.stringify(template, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sensor-data-template.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showStatus('JSONç¯„æœ¬å·²ä¸‹è¼‰', 'success');
        }

        // è‡ªå‹•æ›´æ–°åŠŸèƒ½
        function startAutoRefresh() {
            const url = document.getElementById('jsonUrl').value.trim();
            if (!url) {
                showStatus('è«‹å…ˆè¨­å®šJSON APIç¶²å€æ‰èƒ½è‡ªå‹•æ›´æ–°', 'error');
                return;
            }

            stopAutoRefresh();
            autoRefreshInterval = setInterval(() => {
                loadFromJson();
            }, 30000);
            showStatus('å·²å•Ÿå‹•è‡ªå‹•æ›´æ–° (æ¯30ç§’)', 'success');
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                showStatus('å·²åœæ­¢è‡ªå‹•æ›´æ–°', 'success');
            }
        }

        // CSVè§£æå‡½æ•¸
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const dataLines = lines.filter(line => /\d{4}-\d{2}-\d{2}/.test(line));
            
            return dataLines.map(line => {
                const parts = line.split(',');
                if (parts.length < 7) return null;
                
                const timestamp = parts[0].trim();
                const temp = parseFloat(parts[3]);
                const humidity = parseFloat(parts[4]);
                const soil = parseFloat(parts[5]);
                const light = parseFloat(parts[6]);
                
                if (isNaN(temp) || isNaN(humidity) || isNaN(soil) || isNaN(light)) {
                    return null;
                }
                
                return {
                    timestamp: new Date(timestamp),
                    temperature: temp,
                    humidity: humidity,
                    soilMoisture: soil,
                    light: light
                };
            }).filter(item => item !== null);
        }

        // JSONè§£æå‡½æ•¸
        function parseJSON(jsonData) {
            if (!jsonData || !jsonData.readings || !Array.isArray(jsonData.readings)) {
                throw new Error('JSONæ ¼å¼éŒ¯èª¤ï¼šç¼ºå°‘readingsé™£åˆ—');
            }

            return jsonData.readings.map(reading => {
                if (!reading.timestamp || typeof reading.temperature !== 'number' ||
                    typeof reading.humidity !== 'number' || typeof reading.soil_moisture !== 'number' ||
                    typeof reading.light_intensity !== 'number') {
                    return null;
                }

                return {
                    timestamp: new Date(reading.timestamp),
                    temperature: reading.temperature,
                    humidity: reading.humidity,
                    soilMoisture: reading.soil_moisture,
                    light: reading.light_intensity
                };
            }).filter(item => item !== null);
        }

        // ç‹€æ…‹é¡¯ç¤ºå‡½æ•¸
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
            
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
            }
        }

        // æ¸…ç†ç¾æœ‰åœ–è¡¨
        function clearExistingCharts() {
            Object.values(existingCharts).forEach(chart => {
                if (chart) chart.destroy();
            });
            existingCharts = {};
        }

        // å‰µå»ºåœ–è¡¨å‡½æ•¸
        function createCharts(data) {
            if (data.length === 0) {
                showStatus('æ²’æœ‰æœ‰æ•ˆçš„è³‡æ–™å¯ä»¥é¡¯ç¤º', 'error');
                return;
            }

            clearExistingCharts();
            
            const latestData = data[data.length - 1];

            // æ›´æ–°å³æ™‚æ•¸å€¼
            document.getElementById('current-temp').textContent = latestData.temperature.toFixed(1);
            document.getElementById('current-humidity').textContent = latestData.humidity.toFixed(1);
            document.getElementById('current-soil').textContent = latestData.soilMoisture.toFixed(1);
            document.getElementById('current-light').textContent = latestData.light;

            Chart.defaults.font.family = 'Arial';
            const commonOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } };

            // æ™‚é–“åºåˆ—åœ–
            existingCharts.timeSeries = new Chart(document.getElementById('timeSeriesChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: data.map(d => d.timestamp.toLocaleTimeString('zh-TW', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })),
                    datasets: [
                        { label: 'æº«åº¦ (Â°C)', data: data.map(d => d.temperature), borderColor: '#e74c3c', backgroundColor: 'rgba(231, 76, 60, 0.1)', tension: 0.4 },
                        { label: 'ç’°å¢ƒæ¿•åº¦ (%)', data: data.map(d => d.humidity), borderColor: '#3498db', backgroundColor: 'rgba(52, 152, 219, 0.1)', tension: 0.4 },
                        { label: 'åœŸå£¤æ¿•åº¦ (%)', data: data.map(d => d.soilMoisture), borderColor: '#27ae60', backgroundColor: 'rgba(39, 174, 96, 0.1)', tension: 0.4 }
                    ]
                },
                options: { ...commonOptions, scales: { x: { ticks: { maxTicksLimit: 10 } }, y: { beginAtZero: true, max: 100 } } }
            });

            // é›™Yè»¸åœ–
            existingCharts.dualAxis = new Chart(document.getElementById('dualAxisChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: data.map(d => d.timestamp.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' })),
                    datasets: [
                        { label: 'æº«åº¦ (Â°C)', data: data.map(d => d.temperature), borderColor: '#e74c3c', yAxisID: 'y' },
                        { label: 'æ¿•åº¦ (%)', data: data.map(d => d.humidity), borderColor: '#3498db', yAxisID: 'y' },
                        { label: 'å…‰ç…§ (lux)', data: data.map(d => d.light), borderColor: '#f39c12', yAxisID: 'y1' }
                    ]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        x: { ticks: { maxTicksLimit: 8 } },
                        y: { type: 'linear', position: 'left', title: { display: true, text: 'æº«åº¦/æ¿•åº¦' } },
                        y1: { type: 'linear', position: 'right', title: { display: true, text: 'å…‰ç…§å¼·åº¦ (lux)' }, grid: { drawOnChartArea: false } }
                    }
                }
            });

            // é›·é”åœ–
            const idealConditions = { temperature: 28, humidity: 70, soilMoisture: 65, light: 1000 };
            existingCharts.radar = new Chart(document.getElementById('radarChart').getContext('2d'), {
                type: 'radar',
                data: {
                    labels: ['æº«åº¦é©å®œåº¦', 'ç’°å¢ƒæ¿•åº¦é©å®œåº¦', 'åœŸå£¤æ¿•åº¦é©å®œåº¦', 'å…‰ç…§é©å®œåº¦'],
                    datasets: [
                        { label: 'ç†æƒ³æ¢ä»¶', data: [100, 100, 100, 100], borderColor: '#27ae60', backgroundColor: 'rgba(39, 174, 96, 0.2)' },
                        { label: 'ç•¶å‰ç‹€æ…‹', data: [
                            Math.max(0, 100 - Math.abs(latestData.temperature - idealConditions.temperature) * 5),
                            Math.max(0, 100 - Math.abs(latestData.humidity - idealConditions.humidity) * 2),
                            Math.max(0, 100 - Math.abs(latestData.soilMoisture - idealConditions.soilMoisture) * 3),
                            Math.min(100, (latestData.light / idealConditions.light) * 100)
                        ], borderColor: '#e74c3c', backgroundColor: 'rgba(231, 76, 60, 0.2)' }
                    ]
                },
                options: { ...commonOptions, scales: { r: { beginAtZero: true, max: 100 } } }
            });

            // æ—¥å¤œå¹³å‡æŸ±ç‹€åœ–
            const dayData = data.filter(d => d.timestamp.getHours() >= 6 && d.timestamp.getHours() < 18);
            const nightData = data.filter(d => d.timestamp.getHours() < 6 || d.timestamp.getHours() >= 18);
            
            if (dayData.length > 0 && nightData.length > 0) {
                const avgDay = { 
                    temp: dayData.reduce((s, d) => s + d.temperature, 0) / dayData.length, 
                    humidity: dayData.reduce((s, d) => s + d.humidity, 0) / dayData.length, 
                    light: dayData.reduce((s, d) => s + d.light, 0) / dayData.length 
                };
                const avgNight = { 
                    temp: nightData.reduce((s, d) => s + d.temperature, 0) / nightData.length, 
                    humidity: nightData.reduce((s, d) => s + d.humidity, 0) / nightData.length, 
                    light: nightData.reduce((s, d) => s + d.light, 0) / nightData.length 
                };
                
                existingCharts.bar = new Chart(document.getElementById('barChart').getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['æº«åº¦ (Â°C)', 'æ¿•åº¦ (%)', 'å…‰ç…§ (åƒlux)'],
                        datasets: [
                            { label: 'ç™½å¤©å¹³å‡', data: [avgDay.temp.toFixed(1), avgDay.humidity.toFixed(1), (avgDay.light/1000).toFixed(1)], backgroundColor: 'rgba(241, 196, 15, 0.8)', borderColor: '#f1c40f' },
                            { label: 'å¤œé–“å¹³å‡', data: [avgNight.temp.toFixed(1), avgNight.humidity.toFixed(1), (avgNight.light/1000).toFixed(1)], backgroundColor: 'rgba(52, 73, 94, 0.8)', borderColor: '#34495e' }
                        ]
                    },
                    options: { ...commonOptions, scales: { y: { beginAtZero: true } } }
                });
            }
        }
    </script>
</body>
</html>