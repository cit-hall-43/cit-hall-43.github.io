<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>豬籠草環境監測系統</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Arial', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .dashboard { max-width: 1400px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 30px; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .header p { font-size: 1.2em; opacity: 0.9; }
        .controls { display: flex; justify-content: center; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; }
        .control-group { background: rgba(255, 255, 255, 0.9); padding: 15px; border-radius: 10px; }
        .control-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #2c3e50; }
        .control-group input, .control-group button { padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
        .control-group button { background: #3498db; color: white; border: none; cursor: pointer; transition: background 0.3s; }
        .control-group button:hover { background: #2980b9; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: rgba(255, 255, 255, 0.95); border-radius: 15px; padding: 25px; text-align: center; box-shadow: 0 8px 32px rgba(0,0,0,0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); transition: transform 0.3s ease; }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-value { font-size: 2.5em; font-weight: bold; color: #2c3e50; margin-bottom: 10px; }
        .stat-label { font-size: 1.1em; color: #7f8c8d; font-weight: 500; }
        .stat-unit { font-size: 0.8em; color: #95a5a6; }
        .charts-grid { display: grid; grid-template-columns: 1fr; gap: 30px; }
        .chart-container { background: rgba(255, 255, 255, 0.95); border-radius: 15px; padding: 25px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
        .chart-title { font-size: 1.5em; color: #2c3e50; margin-bottom: 20px; text-align: center; font-weight: 600; }
        .chart-wrapper { position: relative; height: 400px; margin-bottom: 20px; }
        .dual-chart-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        .radar-wrapper { height: 350px; }
        @media (max-width: 768px) { .dual-chart-grid { grid-template-columns: 1fr; } .stats-grid { grid-template-columns: repeat(2, 1fr); } .header h1 { font-size: 2em; } .controls { flex-direction: column; align-items: center; } }
        .temp { color: #e74c3c; } .humidity { color: #3498db; } .soil { color: #27ae60; } .light { color: #f39c12; }
        .status { margin: 10px 0; padding: 10px; border-radius: 5px; text-align: center; font-weight: bold; }
        .status.loading { background: rgba(52, 152, 219, 0.2); color: #2980b9; }
        .status.success { background: rgba(39, 174, 96, 0.2); color: #27ae60; }
        .status.error { background: rgba(231, 76, 60, 0.2); color: #e74c3c; }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>🪴 豬籠草環境監測系統</h1>
            <p>支援CSV檔案上傳或JSON API資料來源</p>
        </div>

        <!-- 控制面板 -->
        <div class="controls">
            <div class="control-group">
                <label for="fileInput">上傳CSV檔案：</label>
                <input type="file" id="fileInput" accept=".csv">
            </div>
            <div class="control-group">
                <label for="jsonUrl">JSON API網址：</label>
                <input type="url" id="jsonUrl" value="https://script.google.com/macros/s/AKfycbxTFL5RSzL5XVQ5feMgDR8jn04wYm849f9E9EZo17tKmqSbP-s3yYF4kF2-CYT1Fg5Wpg/exec" style="width: 300px;">
                <button onclick="loadFromJson()">載入JSON資料</button>
            </div>
            <div class="control-group">
                <button onclick="downloadJsonTemplate()">下載JSON範本</button>
                <button onclick="startAutoRefresh()">自動更新 (30秒)</button>
                <button onclick="stopAutoRefresh()">停止自動更新</button>
            </div>
        </div>

        <!-- 狀態顯示 -->
        <div id="status" class="status" style="display: none;"></div>
        
        <!-- 即時數據 -->
        <div class="stats-grid">
            <div class="stat-card"><div class="stat-value temp" id="current-temp">--</div><div class="stat-label">目前溫度 <span class="stat-unit">°C</span></div></div>
            <div class="stat-card"><div class="stat-value humidity" id="current-humidity">--</div><div class="stat-label">環境濕度 <span class="stat-unit">%</span></div></div>
            <div class="stat-card"><div class="stat-value soil" id="current-soil">--</div><div class="stat-label">土壤濕度 <span class="stat-unit">%</span></div></div>
            <div class="stat-card"><div class="stat-value light" id="current-light">--</div><div class="stat-label">光照強度 <span class="stat-unit">lux</span></div></div>
        </div>
        
        <!-- 圖表 -->
        <div class="charts-grid">
            <div class="chart-container"><div class="chart-title">📊 環境參數時間趨勢圖</div><div class="chart-wrapper"><canvas id="timeSeriesChart"></canvas></div></div>
            <div class="chart-container"><div class="chart-title">🌡️ 溫濕度變化 vs 光照強度</div><div class="chart-wrapper"><canvas id="dualAxisChart"></canvas></div></div>
            <div class="dual-chart-grid">
                <div class="chart-container"><div class="chart-title">🎯 當前環境狀態雷達圖</div><div class="radar-wrapper"><canvas id="radarChart"></canvas></div></div>
                <div class="chart-container"><div class="chart-title">📈 24小時平均值比較</div><div class="radar-wrapper"><canvas id="barChart"></canvas></div></div>
            </div>
        </div>
    </div>

    <script>
        let autoRefreshInterval = null;
        let existingCharts = {};

        // 推薦的JSON格式範例
        const sampleJsonData = {
            "metadata": {
                "station_name": "豬籠草溫室A區",
                "last_updated": "2025-08-15T08:41:29Z",
                "total_records": 34,
                "data_source": "IoT感測器網路"
            },
            "readings": [
                {
                    "timestamp": "2025-08-13T23:40:01Z",
                    "temperature": 26.7,
                    "humidity": 69.6,
                    "soil_moisture": 58,
                    "light_intensity": 0,
                    "sensor_id": "20",
                    "location": "192.168.1.26"
                },
                {
                    "timestamp": "2025-08-14T00:40:14Z",
                    "temperature": 27.7,
                    "humidity": 67.6,
                    "soil_moisture": 60,
                    "light_intensity": 0,
                    "sensor_id": "20",
                    "location": "192.168.1.26"
                },
                {
                    "timestamp": "2025-08-14T06:40:17Z",
                    "temperature": 26.2,
                    "humidity": 66.5,
                    "soil_moisture": 58,
                    "light_intensity": 914,
                    "sensor_id": "20",
                    "location": "192.168.1.26"
                },
                {
                    "timestamp": "2025-08-14T12:40:33Z",
                    "temperature": 32.0,
                    "humidity": 60.6,
                    "soil_moisture": 59,
                    "light_intensity": 3845,
                    "sensor_id": "20",
                    "location": "192.168.1.26"
                },
                {
                    "timestamp": "2025-08-14T18:40:53Z",
                    "temperature": 28.4,
                    "humidity": 66.1,
                    "soil_moisture": 54,
                    "light_intensity": 4,
                    "sensor_id": "20",
                    "location": "192.168.1.26"
                },
                {
                    "timestamp": "2025-08-15T08:41:29Z",
                    "temperature": 29.2,
                    "humidity": 76.2,
                    "soil_moisture": 55,
                    "light_intensity": 65536,
                    "sensor_id": "20",
                    "location": "192.168.1.26"
                }
            ]
        };

        // CSV文件上傳處理
        document.getElementById('fileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;

            showStatus('正在讀取CSV檔案...', 'loading');
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvText = e.target.result;
                    const data = parseCSV(csvText);
                    createCharts(data);
                    showStatus(`成功載入 ${data.length} 筆CSV資料`, 'success');
                } catch (error) {
                    showStatus(`CSV讀取錯誤: ${error.message}`, 'error');
                }
            };
            reader.readAsText(file, 'UTF-8');
        });

        // 從JSON URL載入資料
        async function loadFromJson() {
            const url = document.getElementById('jsonUrl').value.trim();
            if (!url) {
                showStatus('請輸入有效的JSON API網址', 'error');
                return;
            }

            showStatus('正在從API載入資料...', 'loading');
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const jsonData = await response.json();
                const data = parseJSON(jsonData);
                createCharts(data);
                showStatus(`成功載入 ${data.length} 筆JSON資料`, 'success');
            } catch (error) {
                showStatus(`JSON載入錯誤: ${error.message}`, 'error');
            }
        }

        // 載入範例資料
        function loadSampleData() {
            showStatus('載入範例資料中...', 'loading');
            try {
                const data = parseJSON(sampleJsonData);
                createCharts(data);
                showStatus(`載入 ${data.length} 筆範例資料`, 'success');
            } catch (error) {
                showStatus(`範例資料載入錯誤: ${error.message}`, 'error');
            }
        }

        // 下載JSON範本
        function downloadJsonTemplate() {
            const template = {
                "metadata": {
                    "station_name": "豬籠草溫室A區",
                    "last_updated": new Date().toISOString(),
                    "total_records": 6,
                    "data_source": "IoT感測器網路",
                    "description": "這是JSON格式範本，請按照此結構提供您的感測器資料"
                },
                "readings": [
                    {
                        "timestamp": "2025-08-13T23:40:01Z",
                        "temperature": 26.7,
                        "humidity": 69.6,
                        "soil_moisture": 58,
                        "light_intensity": 0,
                        "sensor_id": "20",
                        "location": "192.168.1.26"
                    },
                    {
                        "timestamp": "2025-08-14T06:40:17Z",
                        "temperature": 26.2,
                        "humidity": 66.5,
                        "soil_moisture": 58,
                        "light_intensity": 914,
                        "sensor_id": "20",
                        "location": "192.168.1.26"
                    },
                    {
                        "timestamp": "2025-08-14T12:40:33Z",
                        "temperature": 32.0,
                        "humidity": 60.6,
                        "soil_moisture": 59,
                        "light_intensity": 3845,
                        "sensor_id": "20",
                        "location": "192.168.1.26"
                    },
                    {
                        "timestamp": "2025-08-14T18:40:53Z",
                        "temperature": 28.4,
                        "humidity": 66.1,
                        "soil_moisture": 54,
                        "light_intensity": 4,
                        "sensor_id": "20",
                        "location": "192.168.1.26"
                    },
                    {
                        "timestamp": "2025-08-15T06:41:23Z",
                        "temperature": 27.6,
                        "humidity": 69.7,
                        "soil_moisture": 54,
                        "light_intensity": 845,
                        "sensor_id": "20",
                        "location": "192.168.1.26"
                    },
                    {
                        "timestamp": "2025-08-15T08:41:29Z",
                        "temperature": 29.2,
                        "humidity": 76.2,
                        "soil_moisture": 55,
                        "light_intensity": 65536,
                        "sensor_id": "20",
                        "location": "192.168.1.26"
                    }
                ]
            };

            const jsonString = JSON.stringify(template, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sensor-data-template.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showStatus('JSON範本已下載', 'success');
        }

        // 自動更新功能
        function startAutoRefresh() {
            const url = document.getElementById('jsonUrl').value.trim();
            if (!url) {
                showStatus('請先設定JSON API網址才能自動更新', 'error');
                return;
            }

            stopAutoRefresh();
            autoRefreshInterval = setInterval(() => {
                loadFromJson();
            }, 30000);
            showStatus('已啟動自動更新 (每30秒)', 'success');
        }

        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                showStatus('已停止自動更新', 'success');
            }
        }

        // CSV解析函數
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const dataLines = lines.filter(line => /\d{4}-\d{2}-\d{2}/.test(line));
            
            return dataLines.map(line => {
                const parts = line.split(',');
                if (parts.length < 7) return null;
                
                const timestamp = parts[0].trim();
                const temp = parseFloat(parts[3]);
                const humidity = parseFloat(parts[4]);
                const soil = parseFloat(parts[5]);
                const light = parseFloat(parts[6]);
                
                if (isNaN(temp) || isNaN(humidity) || isNaN(soil) || isNaN(light)) {
                    return null;
                }
                
                return {
                    timestamp: new Date(timestamp),
                    temperature: temp,
                    humidity: humidity,
                    soilMoisture: soil,
                    light: light
                };
            }).filter(item => item !== null);
        }

        // JSON解析函數
        function parseJSON(jsonData) {
            if (!jsonData || !jsonData.readings || !Array.isArray(jsonData.readings)) {
                throw new Error('JSON格式錯誤：缺少readings陣列');
            }

            return jsonData.readings.map(reading => {
                if (!reading.timestamp || typeof reading.temperature !== 'number' ||
                    typeof reading.humidity !== 'number' || typeof reading.soil_moisture !== 'number' ||
                    typeof reading.light_intensity !== 'number') {
                    return null;
                }

                return {
                    timestamp: new Date(reading.timestamp),
                    temperature: reading.temperature,
                    humidity: reading.humidity,
                    soilMoisture: reading.soil_moisture,
                    light: reading.light_intensity
                };
            }).filter(item => item !== null);
        }

        // 狀態顯示函數
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
            
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
            }
        }

        // 清理現有圖表
        function clearExistingCharts() {
            Object.values(existingCharts).forEach(chart => {
                if (chart) chart.destroy();
            });
            existingCharts = {};
        }

        // 創建圖表函數
        function createCharts(data) {
            if (data.length === 0) {
                showStatus('沒有有效的資料可以顯示', 'error');
                return;
            }

            clearExistingCharts();
            
            const latestData = data[data.length - 1];

            // 更新即時數值
            document.getElementById('current-temp').textContent = latestData.temperature.toFixed(1);
            document.getElementById('current-humidity').textContent = latestData.humidity.toFixed(1);
            document.getElementById('current-soil').textContent = latestData.soilMoisture.toFixed(1);
            document.getElementById('current-light').textContent = latestData.light;

            Chart.defaults.font.family = 'Arial';
            const commonOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } };

            // 時間序列圖
            existingCharts.timeSeries = new Chart(document.getElementById('timeSeriesChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: data.map(d => d.timestamp.toLocaleTimeString('zh-TW', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })),
                    datasets: [
                        { label: '溫度 (°C)', data: data.map(d => d.temperature), borderColor: '#e74c3c', backgroundColor: 'rgba(231, 76, 60, 0.1)', tension: 0.4 },
                        { label: '環境濕度 (%)', data: data.map(d => d.humidity), borderColor: '#3498db', backgroundColor: 'rgba(52, 152, 219, 0.1)', tension: 0.4 },
                        { label: '土壤濕度 (%)', data: data.map(d => d.soilMoisture), borderColor: '#27ae60', backgroundColor: 'rgba(39, 174, 96, 0.1)', tension: 0.4 }
                    ]
                },
                options: { ...commonOptions, scales: { x: { ticks: { maxTicksLimit: 10 } }, y: { beginAtZero: true, max: 100 } } }
            });

            // 雙Y軸圖
            existingCharts.dualAxis = new Chart(document.getElementById('dualAxisChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: data.map(d => d.timestamp.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' })),
                    datasets: [
                        { label: '溫度 (°C)', data: data.map(d => d.temperature), borderColor: '#e74c3c', yAxisID: 'y' },
                        { label: '濕度 (%)', data: data.map(d => d.humidity), borderColor: '#3498db', yAxisID: 'y' },
                        { label: '光照 (lux)', data: data.map(d => d.light), borderColor: '#f39c12', yAxisID: 'y1' }
                    ]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        x: { ticks: { maxTicksLimit: 8 } },
                        y: { type: 'linear', position: 'left', title: { display: true, text: '溫度/濕度' } },
                        y1: { type: 'linear', position: 'right', title: { display: true, text: '光照強度 (lux)' }, grid: { drawOnChartArea: false } }
                    }
                }
            });

            // 雷達圖
            const idealConditions = { temperature: 28, humidity: 70, soilMoisture: 65, light: 1000 };
            existingCharts.radar = new Chart(document.getElementById('radarChart').getContext('2d'), {
                type: 'radar',
                data: {
                    labels: ['溫度適宜度', '環境濕度適宜度', '土壤濕度適宜度', '光照適宜度'],
                    datasets: [
                        { label: '理想條件', data: [100, 100, 100, 100], borderColor: '#27ae60', backgroundColor: 'rgba(39, 174, 96, 0.2)' },
                        { label: '當前狀態', data: [
                            Math.max(0, 100 - Math.abs(latestData.temperature - idealConditions.temperature) * 5),
                            Math.max(0, 100 - Math.abs(latestData.humidity - idealConditions.humidity) * 2),
                            Math.max(0, 100 - Math.abs(latestData.soilMoisture - idealConditions.soilMoisture) * 3),
                            Math.min(100, (latestData.light / idealConditions.light) * 100)
                        ], borderColor: '#e74c3c', backgroundColor: 'rgba(231, 76, 60, 0.2)' }
                    ]
                },
                options: { ...commonOptions, scales: { r: { beginAtZero: true, max: 100 } } }
            });

            // 日夜平均柱狀圖
            const dayData = data.filter(d => d.timestamp.getHours() >= 6 && d.timestamp.getHours() < 18);
            const nightData = data.filter(d => d.timestamp.getHours() < 6 || d.timestamp.getHours() >= 18);
            
            if (dayData.length > 0 && nightData.length > 0) {
                const avgDay = { 
                    temp: dayData.reduce((s, d) => s + d.temperature, 0) / dayData.length, 
                    humidity: dayData.reduce((s, d) => s + d.humidity, 0) / dayData.length, 
                    light: dayData.reduce((s, d) => s + d.light, 0) / dayData.length 
                };
                const avgNight = { 
                    temp: nightData.reduce((s, d) => s + d.temperature, 0) / nightData.length, 
                    humidity: nightData.reduce((s, d) => s + d.humidity, 0) / nightData.length, 
                    light: nightData.reduce((s, d) => s + d.light, 0) / nightData.length 
                };
                
                existingCharts.bar = new Chart(document.getElementById('barChart').getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['溫度 (°C)', '濕度 (%)', '光照 (千lux)'],
                        datasets: [
                            { label: '白天平均', data: [avgDay.temp.toFixed(1), avgDay.humidity.toFixed(1), (avgDay.light/1000).toFixed(1)], backgroundColor: 'rgba(241, 196, 15, 0.8)', borderColor: '#f1c40f' },
                            { label: '夜間平均', data: [avgNight.temp.toFixed(1), avgNight.humidity.toFixed(1), (avgNight.light/1000).toFixed(1)], backgroundColor: 'rgba(52, 73, 94, 0.8)', borderColor: '#34495e' }
                        ]
                    },
                    options: { ...commonOptions, scales: { y: { beginAtZero: true } } }
                });
            }
        }
    </script>
</body>
</html>